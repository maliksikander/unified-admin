variables:
  IMAGE_NAME: "${CI_REGISTRY_IMAGE}/build:${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}-${TIME_TOKEN}"
  IMAGE_NAME_BRANCH: "${CI_REGISTRY_IMAGE}/build:${CI_COMMIT_BRANCH}-${CI_COMMIT_SHA}"

include:
  - project: 'cim/ci-templates'
    ref: 'main'
    file: 
      - trivy.yaml
      - grype.yaml
      - build_time.yml
# uncomment if need to publish to dockerhub
#      - dockerhub-publish.yaml
stages:
  - artifacts-frontend
  - test_frontend
  - code_format_frontend
  # - node-scan-frontend
  - sonarqube-scan
  - build-frontend
  - artifacts-backend
  - test_backend
  - code_format_backend
  #- node-scan-backend
  - init
  - build-backend
  - build-gitlab
  - scan
  - publish_dockerhub




node_artifacts_frontend:
   stage: artifacts-frontend
   image: node:14.16.1-alpine3.13
   script:
   - cd Frontend
   - rm -rf node_modules
   - npm install --legacy-peer-deps
   - npm uninstall jest
   - npm install jest@27.4.1
   allow_failure: false
   cache:
       key: $CI_PROJECT_TITLE-frontend
       paths:
           - Frontend/node_modules
   only:
     refs:
       - /^.+_b-.+$/
       - /^.+_f-.+$/
       - merge_requests

# #+==================Runs on Every Commit and merge requests========================+

node-test-frontend:
   stage: test_frontend
   image: node:14.16.1-alpine3.13
   script:
     - cd Frontend
     - npm run coverage --u
   only:
     - /^.+_b-.+$/
     - /^.+_f-.+$/
     - merge_requests
   allow_failure: false
   cache:
        key: $CI_PROJECT_TITLE-frontend
        paths:
            - Frontend/node_modules/
        policy: pull
   artifacts:
        paths:
            - Frontend/coverage


#==============SPACE FOR CODE FORMAT JOB============================



#commented
# node-format-frontend:
#   stage: code_format_frontend
#   when: on_success
#   image: gitlab.expertflow.com:9242/general/node:CSN-3623
#   needs:
#     - job: node-test-frontend
#   script:
#     - npm run format:check
#   allow_failure: false
#   only:
#     - /^.+_f-.+$/
#     - /^.+_b-.+$/
#     - merge_requests
#   cache:
#     key: $CI_PROJECT_TITLE-frontend
#     paths:
#       - node_modules
#     policy: pull



#==========SONARQUBE SCAN for complete project (FRONTEND + BACKEND)==========

sonarqube-test:
  image: 
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  stage: sonarqube-scan
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    #SONAR_HOST_URL: "http://122.129.75.138:9000"
    #SONAR_HOST_URL: "http://124.29.220.135:9000"
    SONAR_HOST_URL: "http://sonarqube.expertflow.com:9000"
    #SONAR_HOST_URL: "http://192.168.1.109:9000"
    SONAR_TOKEN: "sqa_16fe136fb118e04cd6c07a22628f4b951e903c5f"

  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script: 
    - sonar-scanner -X -Dsonar.sources=. -Dsonar.qualitygate.wait=true -Dsonar.projectKey=cim_unified-admin_AYZ5lrsd6ssE7IAn_v9_ -Dsonar.projectName=${CI_PROJECT_NAME}
  # change this to false 
  allow_failure: true 
  only:
    - /^.+_b-.+$/
    - /^.+_f-.+$/
    - merge_requests
    - tags


#==================================================================
angular_build_frontend:
  image: node:14.16.1-alpine3.13
  stage: build-frontend
  needs:
    - job: sonarqube-test
  only:
    - /^.+_b-.+$/
    - /^.+_f-.+$/
    - merge_requests
    - tags
  when: on_success
  cache:
    key: $CI_PROJECT_TITLE-frontend
    paths:
      - Frontend/node_modules/
    policy: pull
  script:
    - cd Frontend
    - npm run build
  artifacts:
    paths:
    - Frontend/dist
  allow_failure: false


#=========================================================#
#=====================Jobs for Backend====================#
#=========================================================#
node-artifacts-backend:
  stage: artifacts-backend
  image: gitlab.expertflow.com:9242/general/node:CSN-3623
  needs:
    - job: angular_build_frontend
  script:
    - cd Backend
    - npm install --legacy-peer-deps
    - npm uninstall ef-keycloak-connect
    - npm install ef-keycloak-connect@1.0.0
    - npm uninstall jest
    - npm install jest@27.4.1
  allow_failure: false
  cache:
    key: $CI_PROJECT_TITLE-backend
    paths:
      - Backend/node_modules
  artifacts:
    paths:
      - Backend/node_modules
  only:
    refs:
      - /^.+_b-.+$/
      - /^.+_f-.+$/
      - merge_requests
      - tags

#+==================Runs on Every Commit and merge requests========================+
#commented
# node-test-backend:
#   stage: test_backend
#   image: node:14.16.1-alpine3.13
#   script:
#     - cd Backend
#     - npm run coverage --u
#   only:
#     - /^.+_b-.+$/
#     - /^.+_f-.+$/
#     - merge_requests
#   allow_failure: false
#   cache:
#     key: $CI_PROJECT_TITLE-backend
#     paths:
#       - Backend/node_modules/
#     policy: pull
#   artifacts:
#     paths:
#       - Backend/coverage



#==================================================================

time_build:
  extends: .build_time
  stage: init
  when: on_success
  only:
    - merge_requests


#==================================================================
node_build_backend:
  image: gitlab.expertflow.com:9242/general/node:CSN-3623
  stage: build-backend
  needs:
    #commented
    #- node-test-backend
    - angular_build_frontend
  cache:
    key: $CI_PROJECT_TITLE-backend
    paths:
      - Backend/node_modules/

    policy: pull
  script:
    - export TIME_TOKEN="$(cat .ci_status/ci_time)"
    - echo "${TIME_TOKEN}"
    - cp -rf Frontend/dist/base-template/* Backend/src/public/
  artifacts:
    name: "$CI_PROJECT_TITLE-$TIME_TOKEN"
    paths:
      - Backend
      - .ci_status/
  allow_failure: false
  only:
    - /^.+_b-.+$/
    - /^.+_f-.+$/
    - merge_requests
    - tags

#+==================Runs on merge requests only========================+
gitlab_build_branch:
 image: docker:latest
 stage: build-gitlab
 when: manual
 services:
   - docker:dind
 before_script:
   - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
 dependencies:
   - node_build_backend
 script:
   - echo ${BUILD_TIME} ${BUILD_NUMBER}
   - cd Backend
   - cp -r $(ls -A | grep -v -E "docker|coverage|.sonar") ./docker/
   - cd docker
   - |-
       if [ $CI_COMMIT_BRANCH != '' ]; then 
         docker build --pull -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" .;
         docker tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" "$IMAGE_NAME_BRANCH";
         docker push "$IMAGE_NAME_BRANCH";
       elif [ $CI_COMMIT_TAG != '' ]; then
         docker build --pull -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG" .;
         docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG";
       fi
 only:
   - /^.+_b-.+$/
   - /^.+_f-.+$/
   - tags
 allow_failure: false


#+==================Runs on merge requests only========================+
gitlab_build_merge:
  image: docker:latest
  stage: build-gitlab
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - apk add --update curl jq
  dependencies:
    - node_build_backend
    - time_build
  variables:
    BRANCH: MERGE_BRANCH
    TIME_VAR: BUILD_TIME
    TOKEN: ${CI_PIPELINE_IID_TOKEN}
    GITLAB_URL: "https://gitlab.expertflow.com"
  script:
    - export TIME_TOKEN="$(cat .ci_status/ci_time)"
    - echo $TIME_TOKEN
    - "curl -s -f --request PUT --header \"PRIVATE-TOKEN: ${TOKEN}\" \"${GITLAB_URL}/api/v4/projects/${CI_PROJECT_ID}/variables/${TIME_VAR}\" --form \"value=${TIME_TOKEN}\" "
    - "curl -s -f --request PUT --header \"PRIVATE-TOKEN: ${TOKEN}\" \"${GITLAB_URL}/api/v4/projects/${CI_PROJECT_ID}/variables/${BRANCH}\" --form \"value=${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}\" "
    - cd Backend
    - ls -ltrh
    - ls -ltrh src/public/
    - cp -r $(ls -A | grep -v -E "docker|coverage|.sonar") ./docker/
    - cd docker
    - ls -ltrh
    - ls -ltrh src/public/
    - docker build --pull -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" .
    - docker logout  $CI_REGISTRY
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" "${CI_REGISTRY_IMAGE}/build:${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}-${TIME_TOKEN}"
    - docker push "${CI_REGISTRY_IMAGE}/build:${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}-${TIME_TOKEN}"

  only:
      - merge_requests
  allow_failure: false
  artifacts:
    paths:
      - .ci_status/

##==================Trivy scan branch========================##
trivy_scanning_branch:
  extends: .trivy_scan_template
  when: on_success
  needs: 
    - job: gitlab_build_branch
  allow_failure: true
  stage: scan
  variables:
    FULL_IMAGE_NAME: ${CI_REGISTRY_IMAGE}/build:${CI_COMMIT_BRANCH}-${CI_COMMIT_SHA}
  only:
    - /^.+_f-.+$/
    - /^.+_b-.+$/


##==================Trivy scan merge========================##
trivy_scanning_merge:
  when: on_success
  stage: scan
  extends: .trivy_scan_template
  before_script:
    - export TIME_TOKEN="$(cat .ci_status/ci_time)"
  needs: 
    - job: gitlab_build_merge
  variables:
    FULL_IMAGE_NAME: ${CI_REGISTRY_IMAGE}/build:${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}-${TIME_TOKEN}
  allow_failure: true
  only:
    - merge_requests
  artifacts:
    paths:
      - .ci_status/


#+==================Runs on if docker build in branch========================+
grype_scan_branch:
  extends: .grype_template
  stage: scan
  needs:
    - job: gitlab_build_branch
  when: on_success
  allow_failure: true
  variables: 
    SCAN_IMAGE: $CI_REGISTRY_IMAGE/build:$CI_COMMIT_BRANCH-$CI_COMMIT_SHA
  only:
    - /^.+_f-.+$/
    - /^.+_b-.+$/


#+==================Runs on merge requests only========================+
grype_scan_merge:
  stage: scan
  extends: .grype_template
  needs:
    - job: gitlab_build_merge  
  when: on_success
  allow_failure: true
  variables:
    SCAN_IMAGE: ${CI_REGISTRY_IMAGE}/build:${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}-${TIME_TOKEN}
  script:
    - export TIME_TOKEN="$(cat .ci_status/ci_time)"
    - docker pull ${SCAN_IMAGE}
    - apk add curl
    - curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
    - grype $SCAN_IMAGE --scope all-layers --fail-on critical > ${CI_PROJECT_TITLE}-vulnerabilities-grype.txt 
  only:
    - merge_requests
  artifacts:
    paths:
      - .ci_status/
  
# #+==================Runs on tag requests only========================+
# uncomment if need to publish to dockerhub

# dockerhub_publish:
#   extends: .publish_dockerhub
#   stage: publish_dockerhub
#   when: on_success
#   needs:
#     - job: gitlab_publish
#   only:
#     - tags
